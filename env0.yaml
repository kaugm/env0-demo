version: 2

deploy:
    onSuccess:
      - name: Puppet
        run: |
          git clone https://github.com/rbenv/rbenv.git ~/.rbenv
          cd ~/.rbenv && src/configure && make -C src
          echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bashrc
          echo 'eval "$(rbenv init - bash)"' >> ~/.bashrc
          exec "$SHELL"
          git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
          rbenv install 3.2.2
          rbenv global 3.2.2
          mkdir -p "$HOME/.gem"
          echo 'export GEM_HOME=$HOME/.gem' >> ~/.bashrc
          echo 'export PATH=$HOME/.gem/bin:$PATH' >> ~/.bashrc
          source ~/.bashrc
          gem install puppet
          echo -e "package { 'nginx':\n  ensure => installed,\n}\n\nservice { 'nginx':\n  ensure => running,\n  enable => true,\n}" > nginx.pp
          puppet apply nginx.pp
